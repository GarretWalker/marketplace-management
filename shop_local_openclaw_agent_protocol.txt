================================================================================
                    SHOP LOCAL MARKETPLACE - OPENCLAW AGENT PROTOCOL
                         Workflow Rules, Scope Boundaries & Guardrails
================================================================================

Date: February 13, 2026
For use by: OpenClaw AI Agent
Status: REQUIRED READING — This document takes priority over general guidelines
        in other documents when there is a conflict.

Reference Docs (read ALL before starting any work):
  1. Shop_Local_Marketplace_Overview.txt   (business context)
  2. shop_local_schema.sql                 (database schema — source of truth)
  3. shop_local_data_model_overview.txt    (data model decisions)
  4. shop_local_sprint_plan.txt            (milestones & task definitions)
  5. shop_local_coding_standards.txt       (code structure & conventions)
  6. THIS DOCUMENT                         (workflow rules & guardrails)


================================================================================
  ⚠️  HARD STOP RULE — READ THIS FIRST  ⚠️
================================================================================

If ANY operation fails 3 times:
  1. STOP ALL WORK IMMEDIATELY. Do not attempt a 4th try.
  2. Document the problem in BLOCKERS.md (what failed, what you tried, errors).
  3. Report the problem through your messaging channel.
  4. WAIT for Garret to respond. Do NOT continue working on anything.

This applies to EVERYTHING: builds, tests, API calls, file operations,
git commands, installs, deployments — anything that fails 3 times in a row.

No exceptions. No workarounds. No "let me try one more thing."
STOP. REPORT. WAIT.

================================================================================
  1. WORKFLOW MODEL
================================================================================

You operate in a three-tier pipeline:

  Garret (Owner)
    → Claude (Architecture, strategy, spec writing, code review guidance)
      → OpenClaw (YOU — Implementation, building, testing)

Your role is EXECUTION. You build what has been specified. You do NOT make
architecture decisions, change data models, or re-design features unless
explicitly instructed.

The workflow for each sprint:
  1. You receive a sprint assignment (a sprint from the sprint plan)
  2. You read ALL reference documents before writing any code
  3. You implement the sprint tasks as specified
  4. When complete, you STOP and report what you built
  5. Garret reviews your work using Claude Code
  6. Garret approves, requests changes, or rejects
  7. Only after approval do you move to the next sprint

You NEVER start the next sprint without explicit approval.
You NEVER work on multiple sprints simultaneously.


================================================================================
  2. SCOPE BOUNDARIES PER SPRINT
================================================================================

Each sprint has a defined scope. You must stay within it.

RULES:
  - Only create or modify files that are directly required by the current
    sprint's task list
  - Do NOT refactor code from previous sprints unless the current sprint
    explicitly requires it
  - Do NOT create placeholder code for future sprints (no "TODO: Sprint 5"
    stubs)
  - Do NOT add features, fields, or endpoints not listed in the sprint tasks
  - Do NOT modify the database schema (shop_local_schema.sql) unless the
    sprint explicitly calls for schema changes
  - Do NOT install packages not listed in the coding standards Key
    Dependencies section without flagging it first

SPRINT SCOPE MAP (which directories/files each sprint should touch):

  Sprint 0 — Project Scaffolding:
    ✅ All directories (initial setup)
    ✅ Configuration files, package.json, tsconfig, etc.
    ✅ Database schema deployment
    ❌ No feature code, no UI beyond "app works"

  Sprint 1 — Chamber Admin Onboarding:
    ✅ /portal: features/chambers/, core/auth/, core/layout/
    ✅ /api: routes/chamber.*, controllers/chamber.*, services/chamber.*
    ✅ /api: middleware/auth.*, middleware/role.*
    ✅ /shared: types/chamber.*, types/profile.*, enums/user-role.*
    ❌ /consumer-marketplace (not started yet)
    ❌ Anything related to merchants, products, orders

  Sprint 2 — ChamberMaster Sync:
    ✅ /portal: features/chambers/ (roster page, sync UI)
    ✅ /api: services/integrations/chambermaster.*, routes/chamber.* (sync endpoints)
    ✅ /api: services/jobs/chambermaster-sync.job.*
    ❌ Merchant onboarding, claim flow, products, orders

  Sprint 3 — Merchant Onboarding & Claims:
    ✅ /portal: features/claims/, features/merchants/ (shell)
    ✅ /api: routes/claim.*, controllers/claim.*, services/claim.*
    ✅ /api: routes/merchant.*, controllers/merchant.*, services/merchant.*
    ✅ /api: services/email.* (first email templates)
    ✅ /shared: types/claim.*, types/merchant.*, enums/merchant-status.*
    ❌ Products, orders, Stripe, integrations

  Sprint 4 — Stripe Connect:
    ✅ /portal: features/merchants/ (Stripe setup, settings page)
    ✅ /api: routes/stripe.*, services/stripe-connect.*, webhooks/stripe.*
    ❌ Products, orders, consumer site

  Sprint 5 — Manual Product Management:
    ✅ /portal: features/products/
    ✅ /api: routes/product.*, controllers/product.*, services/product.*
    ✅ /shared: types/product.*, enums/product-status.*, enums/product-source.*
    ❌ Consumer site, orders, integrations

  Sprint 6 — Consumer Storefront:
    ✅ /consumer-marketplace: ALL (first build of consumer app)
    ✅ /api: routes/public.*, controllers/public.* (public endpoints)
    ❌ Checkout, orders, Shopify/Square integrations

  Sprint 7 — Checkout & Orders:
    ✅ /consumer-marketplace: features/orders/ (checkout, confirmation)
    ✅ /portal: features/orders/ (merchant order management)
    ✅ /api: routes/order.*, controllers/order.*, services/order.*
    ✅ /api: webhooks/stripe.* (payment events)
    ✅ /shared: types/order.*, enums/order-status.*, enums/fulfillment-type.*
    ❌ Shopify/Square integrations

  Sprint 8 — Shopify Integration:
    ✅ /portal: features/integrations/ (Shopify connection UI)
    ✅ /api: services/integrations/shopify.*, webhooks/shopify.*
    ✅ /api: routes/integration.*, controllers/integration.*
    ❌ Square integration, new features

  Sprint 9 — Square Integration:
    ✅ /portal: features/integrations/ (Square connection UI)
    ✅ /api: services/integrations/square.*, webhooks/square.*
    ❌ New features

  Sprint 10 — Polish & Launch Prep:
    ✅ All directories (polish, notifications, final touches)
    ✅ /api: services/notification.*, services/email.* (full notification system)
    ❌ No new major features


================================================================================
  3. BLOCKER & FAILURE PROTOCOL
================================================================================

When you encounter a problem you cannot solve:

  STEP 1: Try up to 3 total attempts to solve it yourself.
          (Original attempt + 2 more. That's it.)

  STEP 2: After 3 failed attempts, STOP IMMEDIATELY. No 4th attempt.
          No "creative workaround." No "slightly different approach."
          STOP.

  STEP 3: Create or update BLOCKERS.md in the project root with:
    - Sprint number and task
    - What you were trying to do
    - What you tried (all 3 approaches)
    - The exact error or issue
    - What you think the cause might be
    - What you need from Garret to proceed

  STEP 4: Report the blocker through your messaging channel and WAIT.
          Do NOT continue working on other tasks in the same sprint.
          Do NOT start the next sprint.
          Do NOT attempt workarounds that deviate from the architecture.

SPECIFIC BLOCKER SCENARIOS:

  External API unreachable (ChamberMaster, Shopify, Square, Stripe):
    - Log the failure
    - Build with mock data / mock service that returns expected shapes
    - Flag in BLOCKERS.md that real API testing is needed
    - Continue building the rest of the sprint with mocks

  Database schema doesn't match what a task needs:
    - Do NOT modify the schema
    - Flag in BLOCKERS.md with proposed change
    - Wait for approval before proceeding

  Ambiguous requirement (task description unclear):
    - Do NOT guess or make assumptions
    - Flag in BLOCKERS.md with your interpretation and ask for clarification
    - If the ambiguity is minor and doesn't affect architecture, use your
      best judgment and note it in the sprint completion report

  Package/dependency not in the approved list:
    - Flag in BLOCKERS.md with why you need it
    - Suggest alternatives from the approved list if possible
    - Wait for approval before installing


================================================================================
  4. TOKEN & COST GUARDRAILS
================================================================================

You are running on paid API credits. Every token costs money. Be efficient.

  HARD LIMITS:
  - Maximum 3 attempts on ANY failed operation — then STOP (see Hard Stop Rule)
  - This means 3 total attempts, not 3 retries (attempt 1 + 2 retries = done)
  - After 3 failed attempts: STOP → BLOCKERS.md → report → WAIT
  - Do NOT try a different approach after 3 failures. STOP AND WAIT.

  EFFICIENCY RULES:
  - Do NOT run infinite loops, recursive API calls, or unbounded retries
  - Do NOT repeatedly regenerate large files — edit incrementally
  - Do NOT run full test suites repeatedly to debug a single test —
    run only the failing test
  - When building UI, get the structure right first, then polish —
    don't iterate on styling 10 times
  - Prefer small, focused commits over large rewrites
  - If you find yourself doing the same thing more than twice and it's
    not working, that counts as your 3 attempts. STOP AND WAIT.


================================================================================
  5. COMMIT & BRANCH CONVENTIONS
================================================================================

Branch naming:
  feature/sprint-{N}-{brief-description}
  Example: feature/sprint-2-chambermaster-sync

One branch per sprint. All work for that sprint goes on that branch.

Commit messages (conventional commits, prefixed with sprint number):
  [S2] feat: add ChamberMaster sync service
  [S2] feat: add member roster page to portal
  [S2] fix: handle pagination in CM API response
  [S2] test: add ChamberMaster sync service tests
  [S2] chore: add node-cron dependency for scheduled sync

Commit granularity:
  - One commit per logical unit of work (one endpoint, one page, one service)
  - NOT one massive commit per sprint
  - NOT micro-commits for every line change
  - Aim for 5-15 commits per sprint

When sprint is complete:
  - Ensure all commits are on the feature branch
  - Do NOT merge to develop — Garret will review and merge
  - Create a sprint completion summary (see Section 7)


================================================================================
  6. TESTING REQUIREMENTS
================================================================================

Before marking a sprint complete, the following must pass:

  MINIMUM TESTING:
  - All API endpoints created in this sprint must have at least:
    - 1 happy-path test (success case)
    - 1 error-path test (validation failure, not found, or unauthorized)
  - All business logic in services must have tests for critical paths
    as defined in the coding standards (Section 12)
  - The application must build without errors (both Angular apps + API)
  - ESLint must pass with no errors (warnings acceptable)

  WHAT YOU DON'T NEED TO TEST:
  - Angular component rendering / templates
  - Basic CRUD operations (simple get-by-id, list-all)
  - Route definitions
  - Styling / layout

  MANUAL VERIFICATION:
  - If the sprint includes UI work, verify the pages render correctly
  - If the sprint includes API work, verify endpoints respond correctly
    using a test script or curl commands
  - Document any manual verification steps you performed in the sprint
    completion report


================================================================================
  7. SPRINT COMPLETION REPORT
================================================================================

When you finish a sprint, create SPRINT_REPORT_{N}.md in the project root:

  # Sprint {N} Completion Report

  ## Summary
  Brief description of what was built.

  ## Tasks Completed
  - [x] Task 1 description
  - [x] Task 2 description
  - [ ] Task 3 (blocked — see Blockers section)

  ## Files Created/Modified
  List of all files you created or significantly modified.

  ## Tests Written
  List of test files and what they cover.

  ## Known Issues
  Anything that works but isn't perfect, edge cases not handled, etc.

  ## Blockers (if any)
  Reference BLOCKERS.md for details.

  ## Dependencies Added
  Any new packages installed (should be from approved list).

  ## Notes for Review
  Anything Garret should pay special attention to during code review.
  Design decisions you made that weren't explicitly specified.

  ## Manual Testing Performed
  Steps you took to verify the sprint works.


================================================================================
  8. TECH STACK CLARIFICATION
================================================================================

The project overview document (Shop_Local_Marketplace_Overview.txt) references
C# / .NET as the backend. THIS IS OUTDATED. The correct and final tech stack
is defined in the sprint plan and coding standards:

  Frontend:        Angular (TypeScript) — two apps (consumer + portal)
  Backend API:     Node.js (TypeScript) with Express
  Database:        Supabase (PostgreSQL + Auth + Storage)
  Payments:        Stripe Connect (Express accounts)
  Email:           TBD (SendGrid, Postmark, or Resend)

If any document contradicts the above, the above is correct.


================================================================================
  9. SEED DATA & DEVELOPMENT SETUP
================================================================================

As part of Sprint 0, create a seed data script: /api/src/seeds/dev-seed.ts

This script should populate the development database with:

  1 Test Chamber:
    - Name: "Cullman Area Chamber of Commerce"
    - Slug: "cullman"
    - Branding: default colors, placeholder logo URL
    - ChamberMaster sync disabled (we'll use mock data)

  3 Test ChamberMaster Members:
    - "John's Hardware" — status: active, not claimed
    - "Sweet Magnolia Bakery" — status: active, not claimed
    - "Cullman Family Pharmacy" — status: active, not claimed

  1 Test Chamber Admin Profile:
    - Email: admin@test.com / Password: testpass123
    - Role: chamber_admin, linked to Cullman chamber

  1 Test Merchant Profile (for sprints 3+):
    - Email: merchant@test.com / Password: testpass123
    - Role: merchant

  1 Test Shopper Profile (for sprints 6+):
    - Email: shopper@test.com / Password: testpass123
    - Role: shopper

  5 Test Products (for sprints 5+):
    - Mix of categories, prices, quantities
    - At least one with compare_at_price (sale item)
    - At least one with track_inventory = false
    - Placeholder image URLs

The seed script should be idempotent (safe to run multiple times).
Run with: npm run seed


================================================================================
  10. TAX HANDLING (INTERIM)
================================================================================

Tax implementation is deferred pending accountant guidance. For all
development work:

  - Set tax_amount to 0.00 on all orders
  - Create a placeholder function in order.service.ts:

    async function calculateTax(
      subtotal: number,
      shippingAddress: ShippingAddress | null
    ): Promise<number> {
      // TODO: Implement tax calculation per accountant guidance
      // Alabama marketplace facilitator laws may apply
      // See: https://revenue.alabama.gov/sales-use/marketplace-facilitators/
      return 0;
    }

  - Display "Tax: $0.00" in checkout UI with no special messaging
  - Do NOT implement any tax calculation logic
  - Do NOT integrate with tax APIs (Avalara, TaxJar, etc.)


================================================================================
  11. EXTERNAL API MOCKING STRATEGY
================================================================================

Several sprints depend on external APIs that may not be available during
development. Use this mocking strategy:

  ChamberMaster API (Sprint 2):
    - Create /api/src/services/integrations/chambermaster.service.ts
      with the real implementation
    - Also create /api/src/services/integrations/chambermaster.mock.ts
      that returns realistic mock data matching the schema
    - Use an environment variable (USE_MOCK_CM=true) to toggle
    - Mock should return 10-20 fake business listings in Cullman
    - Include a mix of active, inactive, and prospective statuses

  Stripe Connect (Sprint 4):
    - Use Stripe TEST MODE (sk_test_* keys) — this is real Stripe,
      just sandboxed
    - Do NOT mock Stripe — the test mode is sufficient
    - Use Stripe's test card numbers for payment testing

  Shopify (Sprint 8) / Square (Sprint 9):
    - Create mock services following the same pattern as ChamberMaster
    - Use mock data that matches realistic product catalogs
    - Flag in BLOCKERS.md when real API testing is needed


================================================================================
  12. SECURITY RULES (NON-NEGOTIABLE)
================================================================================

These rules cannot be overridden regardless of convenience:

  - NEVER store raw API keys in code or committed files
  - NEVER log Stripe secrets, webhook secrets, or OAuth tokens
  - NEVER handle raw credit card data — Stripe.js Elements only
  - NEVER expose internal error details or stack traces to clients
  - NEVER bypass auth middleware on non-public endpoints
  - NEVER use the Supabase service_role_key from Angular apps
  - ALWAYS verify Stripe webhook signatures
  - ALWAYS verify Shopify webhook HMAC signatures
  - ALWAYS parameterize database queries (Supabase client does this)
  - ALWAYS sanitize user input for product names, descriptions, etc.
  - ALWAYS filter queries by the authenticated user's context
    (merchant sees only their data, admin sees only their chamber)


================================================================================
  13. QUALITY CHECKLIST (RUN BEFORE REPORTING SPRINT COMPLETE)
================================================================================

Before reporting a sprint as complete, verify:

  [ ] No operation was retried more than 3 times (if it was, STOP AND WAIT)
  [ ] All sprint tasks are implemented or flagged as blocked
  [ ] Application builds without errors (npm run build for all projects)
  [ ] ESLint passes with no errors
  [ ] All tests pass (npm test)
  [ ] No console.log statements in committed code (use Pino logger)
  [ ] No hardcoded secrets or API keys
  [ ] No commented-out code blocks
  [ ] All new API endpoints follow the { data, error, meta } envelope format
  [ ] All new API endpoints have auth middleware (except /api/public/*)
  [ ] Commit messages follow the [SN] conventional commit format
  [ ] SPRINT_REPORT_{N}.md is created and complete
  [ ] BLOCKERS.md is updated (or empty if no blockers)


================================================================================
