================================================================================
  SPRINT 4 — STRIPE CONNECT & MERCHANT PAYMENTS
================================================================================

Read protocol_core.txt first. This file defines Sprint 4 scope only.

GOAL: Merchants connect Stripe accounts to receive payments.

================================================================================
  SCOPE — ALLOWED FILES
================================================================================

  ✅ /portal: features/merchants/ (Stripe setup, settings page)
  ✅ /api: routes/stripe.*, services/stripe-connect.*, webhooks/stripe.*
  ✅ /api: routes/merchant.* (stripe-status endpoint)
  ❌ Products, orders, consumer site

================================================================================
  REFERENCE FILES (read these for patterns, do NOT modify)
================================================================================

  - api/src/routes/chamber.routes.ts (route pattern)
  - api/src/middleware/auth.middleware.ts (auth pattern)
  - api/src/controllers/claim.controller.ts (controller pattern)
  - portal/src/app/app.routes.ts (routing pattern)

================================================================================
  API ENDPOINTS
================================================================================

  GET /api/stripe/connect
    - Generate Stripe OAuth authorization URL
    - Redirect merchant to Stripe's OAuth consent screen
    - Merchants with existing Stripe accounts authorize access
    - Merchants without Stripe create an account during the flow

  GET /api/stripe/callback
    - Handle OAuth redirect from Stripe
    - Exchange authorization code for stripe_user_id
    - Store stripe_account_id on merchant record
    - Update merchant.stripe_onboarding_complete

  POST /api/stripe/webhook
    - Verify Stripe signature (REQUIRED)
    - Handle account.updated → update payouts_enabled status

  GET /api/merchants/:id/stripe-status
    - Return whether Stripe is fully set up

================================================================================
  PORTAL UI
================================================================================

  Merchant Dashboard — Stripe Setup:
    - Prominent "Set Up Payments" card if Stripe not connected
    - Button text: "Set Up Payments" (NOT "Connect Stripe")
    - On click: redirect to Stripe hosted onboarding
    - On return: show success/pending state
    - Green check if payments enabled, yellow warning if pending

  Merchant Settings Page:
    - Business info (editable)
    - Stripe account status display
    - Shipping/fulfillment toggles:
      - Local pickup (on/off)
      - Flat rate shipping (on/off) + amount input
      - Standard shipping (on/off)
      - Shipping notes text field

================================================================================
  IMPORTANT NOTES
================================================================================

  - Use Stripe Standard connected accounts (NOT Express)
  - Standard allows merchants to connect existing Stripe accounts via OAuth
  - Merchants without Stripe create one during the OAuth flow
  - Use Stripe TEST MODE keys (sk_test_*)
  - All Stripe API calls happen server-side only
  - Webhook endpoint MUST verify Stripe signature
  - If no network access, build all services but flag in BLOCKERS.md
    that real Stripe testing is needed
================================================================================
